name: CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  images:

    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE: ${{ matrix.release_type }}
      RELEASE_VERSION: ${{ matrix.release_version }}
      DOCKER_BASE_REPO: atlas
      DOCKER_TARGET_REPO: ucatlas
      RELEASE: ${{ format('{0}@{1}', matrix.release_type, matrix.release_version) }}
      DOCKER_TARGET_IMAGE: ${DOCKER_TARGET_REPO}/${RELEASE_TYPE}:${RELEASE_VERSION}
    strategy:
      matrix:
        release_type:
          - analysisbase
          - analysistop
        release_version:
          - 21.2.90

    steps:
    - uses: actions/checkout@master
    - name: ${{ env }}
      run: echo "Hello World"
    - name: build $RELEASE
      run: |
        docker build --build-arg GIT_SHA=$GITHUB_SHA \
                     --build-arg DOCKER_BASE_REPO \
                     --build-arg DOCKER_IMG=$RELEASE_TYPE \
                     --build-arg DOCKER_TAG=$RELEASE_VERSION \
                     -t ${DOCKER_TARGET_IMAGE}-latest .
    - name: test default on $RELEASE
      run: |
        docker run --rm ${DOCKER_TARGET_IMAGE}-latest /bin/bash -c "source ~/.bashrc"
    - name: test xAH_run.py on ${{ format('{0}@{1}', matrix.release_type, matrix.release_version) }}
      run: |
        docker run --rm ${DOCKER_TARGET_REPO}/${RELEASE_TYPE}:${RELEASE_VERSION}-latest /bin/bash -c 'source xAODAnaHelpers_setup.sh; xAH_run.py -h'
    - name: login
      run: |
        docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - name: tag $RELEASE
      run: |
        docker tag ${DOCKER_TARGET_IMAGE}-latest ${DOCKER_TARGET_IMAGE}-${GITHUB_SHA::6}-$(date +%Y%m%d)
    - name: push
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |
        docker push ${DOCKER_TARGET_IMAGE}-${GITHUB_SHA::6}-$(date +%Y%m%d)
        docker push ${DOCKER_TARGET_IMAGE}-latest
