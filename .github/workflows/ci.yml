name: CI/CD

on:
  push:
  pull_request:

jobs:
  images:

    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE: ${{ matrix.release_type }}
      RELEASE_VERSION: ${{ matrix.release_version }}
      RELEASE: ${{ format('{0},{1}', matrix.release_type,matrix.release_version) }}
      DOCKER_REPO: atlas
      GIT_SHA: ${{ github.sha }}
    strategy:
      matrix:
        release_type:
          - AnalysisBase
          - AnalysisTop
        release_version:
          - 21.2.90

    steps:
    - uses: actions/checkout@master
    - name: Build ${{ format('{0}@{1}', matrix.release_type, matrix.release_version) }}
      run: |
        export DOCKER_TAG=${RELEASE_VERSION}
        export DOCKER_IMG=$(echo ${RELEASE_TYPE} | tr '[:upper:]' '[:lower:]')
        printenv
        envsubst '\$RELEASE_TYPE' < ci/top_CMakeLists.txt > ci/top_CMakeLists.txt.tmp && mv ci/top_CMakeLists.txt.tmp ci/top_CMakeLists.txt
        cat Dockerfile
        docker build --build-arg RELEASE
                     --build-arg GIT_SHA
                     --build-arg DOCKER_REPO
                     --build-arg DOCKER_IMG
                     --build-arg DOCKER_TAG
                     -t ucatlas/${DOCKER_IMG}:${DOCKER_TAG}-latest .
        #docker run --rm ucatlas/${DOCKER_IMG}:${DOCKER_TAG}-latest
        #docker run --rm ucatlas/${DOCKER_IMG}:${DOCKER_TAG}-latest /bin/bash -c 'source xAODAnaHelpers_setup.sh; xAH_run.py -h'
